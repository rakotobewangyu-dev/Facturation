<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Quotation - Aridago Logistique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .form-section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .form-section h2.main-title {
            border-bottom: 2px solid #ef4444;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        #quotation-preview {
            background: white;
            font-family: 'Helvetica', 'Arial', sans-serif;
            color: #111827;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid #facc15;
            width: 100%;
        }
        #quotation-preview table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            table-layout: fixed;
        }
        #quotation-preview th, #quotation-preview td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            font-size: 0.8rem;
            word-wrap: break-word;
        }
        #quotation-preview th {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
        }
        #quotation-preview .text-right { text-align: right; }
        #quotation-preview .text-center { text-align: center; }
        #quotation-preview .font-bold { font-weight: bold; }

        .panel-controls button {
            color: #9ca3af; /* gray-400 */
        }
        .panel-controls button:hover {
            color: #374151; /* gray-700 */
            background-color: #f3f4f6; /* gray-100 */
        }

        @media (max-width: 640px) {
            #quotation-preview .header-flex {
                flex-direction: column;
                align-items: flex-start;
            }
            #quotation-preview .header-flex div:last-child {
                text-align: left;
                margin-top: 1rem;
            }
            #quotation-preview h3 { font-size: 2rem; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-800">Générateur de Document</h1>
            <p class="text-md lg:text-lg text-gray-500">Inspiré par le format Aridago Expert Service</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                
                <div class="form-section">
                    <h2 class="main-title">Informations Générales</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="documentTitleSelect" class="block text-sm font-medium text-gray-700 mb-1">Type de Document</label>
                            <select id="documentTitleSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                                <option value="QUOTATION">Quotation</option>
                                <option value="DEVIS">Devis</option>
                            </select>
                        </div>
                        <div>
                            <label for="quotationNumber" class="block text-sm font-medium text-gray-700 mb-1">Numéro de Référence</label>
                            <input type="text" id="quotationNumber" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" value="0000000001">
                        </div>
                        <div>
                            <label for="quotationDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="quotationDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="quotationCity" class="block text-sm font-medium text-gray-700 mb-1">Ville</label>
                            <input type="text" id="quotationCity" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" value="Antananarivo">
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h2 class="main-title">CONSIGNÉE (Client)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Nom du client</label>
                            <input type="text" id="clientName" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" value="Nom du client">
                        </div>
                        <div>
                            <label for="clientPhone" class="block text-sm font-medium text-gray-700 mb-1">Téléphone</label>
                            <input type="text" id="clientPhone" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" value="+261 34 00 0000 00">
                        </div>
                        <div>
                            <label for="clientEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="clientEmail" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" value="nomprenom@exemple.com">
                        </div>
                        <div>
                            <label for="clientAddress" class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                            <input type="text" id="clientAddress" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" value="Antananarivo, centre-ville 123">
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h2 class="main-title">Articles</h2>
                    <div id="items-container" class="space-y-6"></div>
                    <button id="addItemBtn" class="mt-4 bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600 transition-colors">
                        Ajouter une ligne
                    </button>
                </div>
                 <div class="form-section">
                    <h2 class="main-title">Pied de Page</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Note importante</label>
                            <textarea id="notes" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">Les frais de transport Chine à Madagascar ne sont pas inclus dans cette Quotation.</textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="paymentMethodSelect" class="block text-sm font-medium text-gray-700 mb-1">Mode de paiement</label>
                                <select id="paymentMethodSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                                    <option>Espèces</option>
                                    <option>Mvola</option>
                                    <option>Airtel Money</option>
                                    <option>Orange Money</option>
                                </select>
                            </div>
                             <div>
                                <label for="exchangeRateInput" class="block text-sm font-medium text-gray-700 mb-1">Cours de change (1 RMB en Ariary)</label>
                                <input type="number" id="exchangeRateInput" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" value="700">
                            </div>
                        </div>
                         <div>
                            <label for="paymentDate" class="block text-sm font-medium text-gray-700 mb-1">Date de paiement</label>
                            <input type="date" id="paymentDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="senderInfo" class="block text-sm font-medium text-gray-700 mb-1">Informations de l'expéditeur</label>
                            <input type="text" id="senderInfo" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" value="Mr. Wang Yu (+86 15600021123)">
                        </div>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-1">
                <div id="right-panels-container" class="lg:sticky top-8 space-y-8">
                    
                    <div class="form-section sortable-panel">
                        <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Action</h2>
                            <div class="panel-controls flex items-center">
                                <button title="Monter" class="move-up-btn p-1 rounded transition-colors">
                                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                </button>
                                <button title="Descendre" class="move-down-btn p-1 rounded transition-colors">
                                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-center">
                            <span class="text-3xl font-bold text-gray-800" id="totalDisplay">0.00 Ar</span>
                            <p class="text-gray-500">Total</p>
                        </div>
                        <button id="generateImageBtn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors text-lg mt-4">
                            Télécharger l'Aperçu (Image)
                        </button>
                    </div>

                    <div class="form-section sortable-panel">
                        <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Convertisseur</h2>
                            <div class="panel-controls flex items-center">
                                <button id="swapConverterBtn" title="Inverser la conversion" class="p-1 rounded transition-colors mr-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                                </button>
                                <button title="Monter" class="move-up-btn p-1 rounded transition-colors">
                                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                </button>
                                <button title="Descendre" class="move-down-btn p-1 rounded transition-colors">
                                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label id="converterInputLabel" for="converterInput" class="block text-sm font-medium text-gray-700 mb-1"></label>
                            <input type="number" id="converterInput" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="mt-4 text-center">
                            <p id="converterOutputLabel" class="text-sm text-gray-500"></p>
                            <p id="converterOutputResult" class="text-2xl font-bold text-green-600"></p>
                        </div>
                    </div>

                    <div class="form-section sortable-panel">
                        <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-4">
                             <h2 class="text-lg font-semibold text-gray-800">Calculateur de Bénéfice</h2>
                            <div class="panel-controls flex items-center">
                                <button title="Monter" class="move-up-btn p-1 rounded transition-colors">
                                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                </button>
                                <button title="Descendre" class="move-down-btn p-1 rounded transition-colors">
                                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                         <div>
                            <label for="profit-base-amount" class="block text-sm font-medium text-gray-700 mb-1">Montant de base (Optionnel)</label>
                            <div class="flex space-x-2">
                                <input type="number" id="profit-base-amount" placeholder="Total par défaut" class="w-2/3 p-2 border border-gray-300 rounded-md">
                                <select id="profit-base-currency" class="w-1/3 p-2 border border-gray-300 rounded-md">
                                    <option value="MGA">Ariary</option>
                                    <option value="RMB">RMB</option>
                                </select>
                            </div>
                        </div>
                         <div class="mt-4">
                             <label for="profit-percentage" class="block text-sm font-medium text-gray-700 mb-1">Pourcentage de bénéfice (%)</label>
                             <input type="number" id="profit-percentage" class="w-full p-2 border border-gray-300 rounded-md" value="10">
                         </div>
                         <div id="profit-results" class="mt-4 text-center">
                             <p class="text-sm text-gray-500">Bénéfice à ajouter (Ariary)</p>
                             <p id="profit-ariary" class="text-xl font-bold text-blue-600">0 Ar</p>
                             <p class="text-sm text-gray-500 mt-2">Bénéfice à ajouter (RMB)</p>
                             <p id="profit-rmb" class="text-xl font-bold text-blue-600">0.00 RMB</p>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section mt-8">
            <h2 class="main-title">Aperçu du Document</h2>
            <div id="quotation-preview-container" class="overflow-x-auto">
                <div id="quotation-preview">
                    </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- LOGIC FOR THE QUOTATION GENERATOR ---
        const logoTopLeftUrl = "https://i.ibb.co/HDBqLXCT/Aridago-Logo-removebg-preview.png";
        const logoBottomRightUrl = "https://i.ibb.co/mFyw1zmW/Sary-sonia.png";

        let state = {
            documentTitle: 'QUOTATION',
            quotationNumber: '0000000001',
            quotationDate: new Date().toISOString().split('T')[0],
            quotationCity: 'Antananarivo',
            clientName: 'Nom du client',
            clientPhone: '+261 34 00 0000 00',
            clientEmail: 'nomprenom@exemple.com',
            clientAddress: 'Antananarivo, centre-ville 123',
            items: [
                { id: 1, description: 'Produit 1', specification: 'Spécification du produit 1', quantity: 1, price: 100000, isText: false, directPrice: 0, align: 'left' },
                { id: 2, description: 'Produit 2', specification: 'Détails pour le produit 2 avec beaucoup de texte ici, pour tester la justification et le débordement de texte dans la colonne. Cela devrait s\'enrouler joliment sans perturber le tableau.', quantity: 2, price: 30000, isText: false, directPrice: 0, align: 'left' },
                { id: 3, description: 'Dédouanement + Fret', specification: '0,05 Cbm', quantity: 1, price: 0, isText: true, directPrice: 150000, align: 'left' }
            ],
            notes: 'Les frais de transport Chine à Madagascar ne sont pas inclus dans cette Quotation.',
            paymentMethod: 'Espèces',
            exchangeRate: 700,
            paymentDate: '',
            senderInfo: 'Mr. Wang Yu (+86 15600021123)',
        };

        let isRmbToAriary = true;

        function getFormattedDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let formatted = new Intl.DateTimeFormat('fr-FR', options).format(date);
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        }

        function getFormattedPaymentDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            date.setDate(date.getDate() + 1); 
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function renderQuotationPreview() {
            const previewContainer = document.getElementById('quotation-preview');
            
            let tableRows = '';
            let total = 0;

            state.items.forEach(item => {
                if (item.isText) {
                    const directPrice = item.directPrice || 0;
                    total += directPrice;
                    tableRows += `
                        <tr style="background-color: #f3f4f6;">
                            <td colspan="2" class="font-bold" style="text-align: ${item.align || 'left'};">${item.description}</td>
                            <td class="text-center">${item.specification}</td>
                            <td></td>
                            <td class="text-right font-bold">${directPrice.toLocaleString('fr-FR')}</td>
                        </tr>
                    `;
                } else {
                    const itemTotal = item.quantity * item.price;
                    total += itemTotal;
                    tableRows += `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.specification}</td>
                            <td class="text-center">${item.quantity.toLocaleString('fr-FR')}</td>
                            <td class="text-right">${item.price.toLocaleString('fr-FR')}</td>
                            <td class="text-right">${itemTotal.toLocaleString('fr-FR')}</td>
                        </tr>
                    `;
                }
            });

            const totalRmb = state.exchangeRate > 0 ? total / state.exchangeRate : 0;

            tableRows += `
                <tr>
                    <td colspan="3"></td>
                    <td class="text-right font-bold" style="font-size: 1.1em;">TOTAUX</td>
                    <td class="text-right font-bold" style="font-size: 1.2em; vertical-align: middle;">
                        ${total.toLocaleString('fr-FR')} Ar
                        <br>
                        <span style="font-size: 0.8em; font-weight: 500;">(${totalRmb.toFixed(2)} RMB)</span>
                    </td>
                </tr>
            `;
            
            let paymentTermsText = `(1) Mode de paiement: ${state.paymentMethod}\n(2) Prix de Change: 1 RMB = ${state.exchangeRate} Ariary`;
            if (state.paymentDate) {
                 paymentTermsText += `\n(3) Date de paiement : ${getFormattedPaymentDate(state.paymentDate)}`;
            }
            
            let signatureHtml = '';
            if (state.documentTitle === 'DEVIS') {
                signatureHtml = `<img src="${logoBottomRightUrl}" alt="Signature" style="width: 220px; height: auto; margin-left: auto; margin-top: 0.5rem;">`;
            }

            previewContainer.innerHTML = `
                <div style="background-color: #fefce8; padding: 1rem 1.5rem; border-bottom: 3px solid #f59e0b;">
                     <div class="header-flex" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <img src="${logoTopLeftUrl}" alt="Aridago Logo" style="width: 150px; height: auto;">
                        </div>
                        <div class="text-right">
                            <h3 style="font-size: 2.2rem; font-weight: 700; color: #000000; line-height: 1;">${state.documentTitle}</h3>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem;"><strong>Numéro :</strong> ${state.quotationNumber}</p>
                        </div>
                    </div>
                </div>

                <div style="padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap;">
                         <div style="margin-bottom: 1rem;">
                            <p style="background-color: #e5e7eb; padding: 0.25rem 0.5rem; display: inline-block; font-weight: bold; margin-bottom: 0.5rem; border-radius: 4px; font-size: 0.9rem;">CONSIGNÉE À :</p>
                            <p><span class="font-bold">Nom :</span> ${state.clientName}</p>
                            <p><span class="font-bold">Tél :</span> ${state.clientPhone}</p>
                            <p><span class="font-bold">Email :</span> ${state.clientEmail}</p>
                            <p><span class="font-bold">Adresse :</span> ${state.clientAddress}</p>
                        </div>
                        <p class="text-right" style="width: 100%; md:width: auto;"><strong>${state.quotationCity}</strong>, ${getFormattedDate(state.quotationDate)}</p>
                    </div>

                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 25%;">DESCRIPTION</th>
                                    <th style="width: 35%;">SPÉCIFICATION</th>
                                    <th style="width: 10%;">QUANTITÉ</th>
                                    <th style="width: 15%;">PRIX UNITAIRE (Ar)</th>
                                    <th style="width: 15%;">TOTAL (Ar)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr; md:grid-template-columns: 2fr 1fr; gap: 2rem; margin-top: 2rem; align-items: start;">
                        <div style="font-size: 0.8rem;">
                            <div style="margin-bottom: 1rem;">
                                <p class="font-bold">Note importante:</p>
                                <p style="white-space: pre-wrap;">${state.notes}</p>
                            </div>
                             <div>
                                <p class="font-bold">Terme de paiement:</p>
                                <p style="white-space: pre-wrap;">${paymentTermsText}</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                             <p class="font-bold" style="padding-right: 38px;">Expéditeur</p>
                             ${signatureHtml}
                             <p style="margin-top: 1rem;">${state.senderInfo}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderItemsForm() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';
            state.items.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-x-2 gap-y-3 items-center border-t pt-4 first:border-t-0 first:pt-0';
                
                const standardInputs = `
                    <div class="col-span-6 md:col-span-3">
                        <label class="block text-xs text-gray-500">Quantité</label>
                        <input type="number" placeholder="Qté" data-id="${item.id}" data-field="quantity" value="${item.quantity}" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-6 md:col-span-3">
                        <label class="block text-xs text-gray-500">Prix Unitaire (Ar)</label>
                        <input type="number" placeholder="P.U. (Ar)" data-id="${item.id}" data-field="price" value="${item.price}" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                `;

                const textOnlyInput = `
                    <div class="col-span-12 md:col-span-6">
                         <label class="block text-xs text-gray-500">Prix Total (Ar)</label>
                         <input type="number" placeholder="Prix Total (Ar)" data-id="${item.id}" data-field="directPrice" value="${item.directPrice || 0}" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                `;

                row.innerHTML = `
                    <div class="col-span-12 md:col-span-6">
                        <label class="block text-xs text-gray-500">Description</label>
                        <input type="text" placeholder="Description" data-id="${item.id}" data-field="description" value="${item.description}" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-12 md:col-span-6">
                        <label class="block text-xs text-gray-500">Spécification</label>
                        <input type="text" placeholder="Spécification" data-id="${item.id}" data-field="specification" value="${item.specification || ''}" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    
                    ${item.isText ? textOnlyInput : standardInputs}
                    
                    <div class="col-span-12 flex items-center justify-between">
                         <div class="flex items-center">
                            <input type="checkbox" data-id="${item.id}" data-field="isText" class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded" ${item.isText ? 'checked' : ''}>
                            <label class="ml-2 text-sm text-gray-600">Texte seul / Service</label>
                        </div>
                        <div class="flex items-center space-x-2">
                             <button title="Monter" data-id="${item.id}" class="move-up-btn p-1 rounded ${index === 0 ? 'opacity-25 cursor-not-allowed' : 'hover:bg-gray-200'}" ${index === 0 ? 'disabled' : ''}>
                               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                            </button>
                            <button title="Descendre" data-id="${item.id}" class="move-down-btn p-1 rounded ${index === state.items.length - 1 ? 'opacity-25 cursor-not-allowed' : 'hover:bg-gray-200'}" ${index === state.items.length - 1 ? 'disabled' : ''}>
                               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <button data-id="${item.id}" class="removeItemBtn bg-red-100 text-red-600 p-2 rounded-full hover:bg-red-200 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            updateTotalAndPreview();
        }

        function updateTotalAndPreview() {
            const total = state.items.reduce((acc, item) => {
                if (item.isText) {
                    return acc + (item.directPrice || 0);
                } else {
                    return acc + (item.quantity * item.price);
                }
            }, 0);

            const totalRmb = state.exchangeRate > 0 ? total / state.exchangeRate : 0;
            
            document.getElementById('totalDisplay').innerHTML = `
                ${total.toLocaleString('fr-FR')} Ar
                <br>
                <span class="text-xl font-semibold text-gray-500">(${totalRmb.toFixed(2)} RMB)</span>`;
                
            renderQuotationPreview();
            updateProfitCalculator();
        }

        function syncStateWithForm() {
            state.documentTitle = document.getElementById('documentTitleSelect').value;
            state.quotationNumber = document.getElementById('quotationNumber').value;
            state.quotationDate = document.getElementById('quotationDate').value;
            state.quotationCity = document.getElementById('quotationCity').value;
            state.clientName = document.getElementById('clientName').value;
            state.clientPhone = document.getElementById('clientPhone').value;
            state.clientEmail = document.getElementById('clientEmail').value;
            state.clientAddress = document.getElementById('clientAddress').value;
            state.notes = document.getElementById('notes').value;
            state.paymentMethod = document.getElementById('paymentMethodSelect').value;
            state.exchangeRate = parseFloat(document.getElementById('exchangeRateInput').value) || 0;
            state.paymentDate = document.getElementById('paymentDate').value;
            state.senderInfo = document.getElementById('senderInfo').value;
            updateTotalAndPreview();
        }

        function updateConverterUI() {
            const inputLabel = document.getElementById('converterInputLabel');
            const outputLabel = document.getElementById('converterOutputLabel');
            const converterInput = document.getElementById('converterInput');

            if (isRmbToAriary) {
                inputLabel.textContent = 'Montant en RMB (¥)';
                outputLabel.textContent = 'Équivalent en Ariary';
                converterInput.placeholder = 'Entrez la valeur en RMB';
            } else {
                inputLabel.textContent = 'Montant en Ariary (Ar)';
                outputLabel.textContent = 'Équivalent en RMB';
                converterInput.placeholder = 'Entrez la valeur en Ariary';
            }
            updateConverter();
        }

        function updateConverter() {
            const amount = parseFloat(document.getElementById('converterInput').value) || 0;
            const resultEl = document.getElementById('converterOutputResult');
            const exchangeRate = state.exchangeRate;

            if (isRmbToAriary) {
                const calculatedAriary = amount * exchangeRate;
                resultEl.textContent = `${calculatedAriary.toLocaleString('fr-FR')} Ar`;
            } else {
                const calculatedRmb = exchangeRate > 0 ? amount / exchangeRate : 0;
                resultEl.textContent = `${calculatedRmb.toFixed(2).replace('.', ',')} RMB`;
            }
        }

        function updateProfitCalculator() {
            const customBaseAmountInput = parseFloat(document.getElementById('profit-base-amount').value) || 0;
            const currency = document.getElementById('profit-base-currency').value;
            const percentage = parseFloat(document.getElementById('profit-percentage').value) || 0;
            
            let baseAmountInAriary = 0;

            if (customBaseAmountInput > 0) {
                 if (currency === 'RMB') {
                    baseAmountInAriary = customBaseAmountInput * state.exchangeRate;
                } else {
                    baseAmountInAriary = customBaseAmountInput;
                }
            } else {
                baseAmountInAriary = state.items.reduce((acc, item) => {
                    if (item.isText) {
                        return acc + (item.directPrice || 0);
                    } else {
                        return acc + (item.quantity * item.price);
                    }
                }, 0);
            }

            const profitAriary = (baseAmountInAriary * percentage) / 100;
            const profitRmb = state.exchangeRate > 0 ? profitAriary / state.exchangeRate : 0;

            document.getElementById('profit-ariary').textContent = `${profitAriary.toLocaleString('fr-FR')} Ar`;
            document.getElementById('profit-rmb').textContent = `${profitRmb.toFixed(2)} RMB`;
        }

        // --- PANEL REORDERING LOGIC ---
        const rightPanelsContainer = document.getElementById('right-panels-container');

        function updateMoveButtons() {
            const panels = rightPanelsContainer.querySelectorAll('.sortable-panel');
            panels.forEach((panel, index) => {
                const upBtn = panel.querySelector('.move-up-btn');
                const downBtn = panel.querySelector('.move-down-btn');

                if (upBtn) upBtn.style.display = (index === 0) ? 'none' : 'block';
                if (downBtn) downBtn.style.display = (index === panels.length - 1) ? 'none' : 'block';
            });
        }

        rightPanelsContainer.addEventListener('click', (e) => {
            const upBtn = e.target.closest('.move-up-btn');
            const downBtn = e.target.closest('.move-down-btn');
            
            if (!upBtn && !downBtn) return;

            const panel = e.target.closest('.sortable-panel');
            if (!panel) return;

            if (upBtn) {
                const prevPanel = panel.previousElementSibling;
                if (prevPanel) {
                    rightPanelsContainer.insertBefore(panel, prevPanel);
                    updateMoveButtons();
                }
            }

            if (downBtn) {
                const nextPanel = panel.nextElementSibling;
                if (nextPanel) {
                    rightPanelsContainer.insertBefore(nextPanel, panel);
                    updateMoveButtons();
                }
            }
        });


        // --- EVENT LISTENERS INITIALIZATION ---
        document.getElementById('quotationDate').value = state.quotationDate;
        syncStateWithForm();
        renderItemsForm();
        document.querySelector('.lg\\:col-span-2').addEventListener('input', syncStateWithForm);
        document.getElementById('addItemBtn').addEventListener('click', () => {
            state.items.push({ id: Date.now(), description: '', specification: '', quantity: 1, price: 0, isText: false, directPrice: 0, align: 'left' });
            renderItemsForm();
        });
        document.getElementById('items-container').addEventListener('input', (e) => {
            const target = e.target;
            if (target.dataset.id && target.dataset.field) {
                const id = parseInt(target.dataset.id);
                const field = target.dataset.field;
                const item = state.items.find(i => i.id === id);
                if (!item) return;
                let needsReRender = false;
                const oldValue = item[field];
                let newValue;
                if (target.type === 'checkbox') {
                    newValue = target.checked;
                    if (oldValue !== newValue) needsReRender = true;
                } else if (target.type === 'number') {
                    newValue = parseFloat(target.value) || 0;
                } else {
                    newValue = target.value;
                }
                item[field] = newValue;
                if (needsReRender) {
                    renderItemsForm();
                } else {
                    updateTotalAndPreview();
                }
            }
        });
        document.getElementById('items-container').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = parseInt(button.dataset.id);
            if (!id) return;
            if (button.classList.contains('removeItemBtn')) {
                state.items = state.items.filter(i => i.id !== id);
                renderItemsForm();
            } else if (button.classList.contains('move-up-btn')) {
                const index = state.items.findIndex(i => i.id === id);
                if (index > 0) {
                    [state.items[index - 1], state.items[index]] = [state.items[index], state.items[index - 1]];
                    renderItemsForm();
                }
            } else if (button.classList.contains('move-down-btn')) {
                const index = state.items.findIndex(i => i.id === id);
                if (index < state.items.length - 1) {
                    [state.items[index + 1], state.items[index]] = [state.items[index], state.items[index + 1]];
                    renderItemsForm();
                }
            }
        });
        document.getElementById('generateImageBtn').addEventListener('click', () => {
            const elementToCapture = document.getElementById('quotation-preview');
            const originalWidth = elementToCapture.style.width;
            elementToCapture.style.width = '1024px';
            html2canvas(elementToCapture, { scale: 2, useCORS: true, windowWidth: 1024 }).then(canvas => {
                const imageURL = canvas.toDataURL('image/png');
                const downloadLink = document.createElement('a');
                downloadLink.href = imageURL;
                downloadLink.download = `${state.documentTitle}_${state.quotationNumber}.png`;
                downloadLink.click();
                elementToCapture.style.width = originalWidth;
            });
        });
        document.getElementById('swapConverterBtn').addEventListener('click', () => {
            isRmbToAriary = !isRmbToAriary;
            document.getElementById('converterInput').value = '';
            updateConverterUI();
        });
        document.getElementById('converterInput').addEventListener('input', updateConverter);
        document.getElementById('exchangeRateInput').addEventListener('input', () => {
            syncStateWithForm();
            updateConverter();
        });
        document.getElementById('profit-percentage').addEventListener('input', updateProfitCalculator);
        document.getElementById('profit-base-amount').addEventListener('input', updateProfitCalculator);
        document.getElementById('profit-base-currency').addEventListener('change', updateProfitCalculator);
        
        // Initial calls
        updateConverterUI();
        updateMoveButtons(); // Set initial state for move buttons
    });
    </script>
</body>
</html>

